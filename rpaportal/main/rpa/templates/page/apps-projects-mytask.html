<!DOCTYPE html>
{% load static %}
<html lang="ko">

<head>
    <meta charset="utf-8"/>
    <title> RPA PORTAL </title>
    {% include 'page/head_basic_scripts.html' %}
        <style>
        .modal {
          display: none;
          z-index: 999999;
        }

        .modal-header {
          cursor: grab;
        }

    </style>
</head>

<body>
        <!-- Pre-loader -->
        <div id="preloader">
            <div id="status">
                <div class="bouncing-loader"><div ></div><div ></div><div ></div></div>
            </div>
        </div>
<!-- Begin page -->
<div class="wrapper">
    {% include 'page/navbar_top.html' %}
    {% include 'page/navbar_left.html' %}

    <div class="content-page">
        <div class="content">

            <!-- Start Content-->
            <div class="container-fluid">

                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box">
                            <div class="page-title-right">
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item">RPA과제</li>
                                    <li class="breadcrumb-item">내 과제</li>
                                </ol>
                            </div>
                            <h4 class="page-title">과제 리스트</h4>
                        </div>
                    </div>
                </div>
                <!-- end page title -->


                <div class="row mb-2">
                    <div class="col-sm-4">

                    </div>
                    <div class="col-sm-8">
                        <div class="text-sm-end btns">
                            <div class="btn-group mb-3">
                                <button type="button" id="alltask" class="btn btn-primary" onclick="alltask(this);">All</button>
                            </div>
                            <div class="btn-group mb-3 ms-1">
                                <button type="button" id="ongoing" class="btn btn-light" onclick="ongoing(this);">개발 완료</button>
                                <button type="button" id="ongoing_dev" class="btn btn-light" onclick="ongoing_dev(this);">개발 진행중</button>
                                <button type="button" id="stoptask" class="btn btn-light" onclick="stoptask(this);">중단</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    {% for task in rpatasklist %}
                    <div class="col-md-6 col-xxl-3 {{ task.progress_status }}" style="display: inline;">
                        <!-- project card -->
                        <div class="card d-block">
                            <div class="card-body">
                                <div class="dropdown card-widgets">
                                    {% if '접수' in task.progress_status %}
                                    <span class="badge bg-info" data-bs-toggle="tooltip" data-bs-placement="top"
                                    data-bs-title="과제 접수가 완료되었습니다.">
                                        {{ task.progress_status }}
                                    </span>
                                    {% elif '개발중' in task.progress_status %}
                                    <span class="badge bg-primary" data-bs-toggle="tooltip" data-bs-placement="top"
                                    data-bs-title="RPA 개발중입니다.">
                                        {{ task.progress_status }}
                                    </span>
                                    {% elif '재개발' in task.progress_status %}
                                    <span class="badge badge-primary-lighten" data-bs-toggle="tooltip" data-bs-placement="top"
                                    data-bs-title="RPA 재개발 예정입니다.">
                                        {{ task.progress_status }}
                                    </span>
                                    {% elif '개발완료' in task.progress_status %}
                                    <span class="badge bg-success">
                                        {{ task.progress_status }}
                                    </span>
                                    {% elif '개발보류' in task.progress_status %}
                                    <span class="badge bg-warning" data-bs-toggle="tooltip" data-bs-placement="top"
                                    data-bs-title="특정 사유로 개발이 보류되었습니다.">
                                        {{ task.progress_status }
                                        }</span>
                                    {% elif '임시중단' in task.progress_status %}
                                    <span class="badge bg-warning" data-bs-toggle="tooltip" data-bs-placement="top"
                                    data-bs-title="잠시 RPA를 중단했습니다.">
                                        {{ task.progress_status }}
                                    </span>
                                    {% elif '운영중단' in task.progress_status %}
                                    <span class="badge badge-dark-lighten" data-bs-toggle="tooltip" data-bs-placement="top"
                                    data-bs-title="RPA 수행이 중지되었습니다.">
                                        {{ task.progress_status }}
                                    </span>
                                    {% elif '개발중단' in task.progress_status %}
                                    <span class="badge bg-danger">
                                        {{ task.progress_status }}
                                    </span>
                                    {% elif '요청철회' in task.progress_status %}
                                    <span class="badge bg-danger">
                                        {{ task.progress_status }}
                                    </span>
                                    {% endif %}
                                </div>
                                <!-- project title-->
                                <h4 class="mt-0">
                                    <a href="/taskList/{{ task.id }}/" class="text-title" style="font-size: 16px;">{{ task.taskname }}</a>
                                </h4>
                                <p class="mb-2">
                                    <span class="pe-2 text-nowrap mb-2 d-inline-block"  style="font-size: 13px;">
                                            <b>요청일: </b> {{ task.created_date|date:'Y-m-d H:i' }}
                                        </span>
                                </p>
                                <div class="scrollable-content" style="min-height: 120px; max-height: 120px; overflow-y: auto;">
                                <p class="text-muted font-13"> {{ task.taskexplanation|linebreaks }}
                                </p>
                                </div>
                                <!-- project detail-->
                            </div> <!-- end card-body-->
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">

                                    {% if '접수' in task.progress_status %}

                                    <div class="mb-2 fw-bold" style="line-height : 40%;"><small>1. 과제 접수:</small> ✔</div>
                                    <div class="dropdown float-end">
                                            <a href="#" class="dropdown-toggle arrow-none card-drop" data-bs-toggle="dropdown"
                                               aria-expanded="false">
                                                <i class="mdi mdi-dots-vertical"></i>
                                            </a>
                                            <div class="dropdown-menu dropdown-menu-end">
                                                <a class="dropdown-item"  data-bs-toggle="modal" data-bs-target="#danger-header-modal{{ task.id }}">요청철회</a>
                                            </div>
                                        <div id="danger-header-modal{{ task.id }}" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="danger-header-modalLabel" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header bg-danger">
                                                        <h4 class="modal-title" id="danger-header-modalLabel">요청 철회</h4>

                                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-hidden="true"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <p>과제명: <mark>{{ task.taskname }}</mark></p>

                                                        사유:
                                                        <textarea class="form-control form-control-light mb-2"
                                                              placeholder="작성"
                                                              id="explanation-textarea{{ task.id }}"
                                                              rows="7">{{ taskexplanation }}</textarea>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-danger" onclick="cancelrequest('{{ task.id }}');">확인</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        </div>
                                    <div class="mb-2 fw-bold" style="line-height : 40%;"><small>2. RPA담당자 확인:</small>
                                        {% for detail in detail_info %}

                                            {% if task.id|stringformat:"s" == detail.rpa_id|stringformat:"s"  and detail.rpamanager_chk == "Y" %}
                                                ✔
                                            {% endif %}

                                        {% endfor %}
                                    </div>

                                    <div class="mb-2 fw-bold" style="line-height : 40%;"><small>3. 업무 분석(인터뷰) 완료:</small>
                                        {% for detail in detail_info %}
                                            {% if task.id|stringformat:"s" == detail.rpa_id|stringformat:"s"  and detail.analyze_date != "" %}
                                                ✔
                                            {% endif %}
                                        {% endfor %}

                                    </div>


                                    {% elif '개발중' in task.progress_status %}
                                    <!-- project progress-->
                                    <p class="mb-2 fw-bold">개발 진척
                                        <i type="button" class="mdi mdi-form-select" data-bs-toggle="modal"
                                           data-bs-target="#standard-modal{{ task.id }}"></i>

                                        <span class="float-end" id="float-end{{ task.id }}">10%</span>
                                    </p>
                                    <div class="progress progress-sm">
                                        <div class="progress-bar" role="progressbar" id="progressbar{{ task.id }}" aria-valuenow="0"
                                             aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                                        </div><!-- /.progress-bar -->
                                    </div><!-- /.progress -->
                                    <div id="standard-modal{{ task.id }}" class="modal fade" tabindex="-1" role="dialog"
                                         aria-labelledby="standard-modalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h4 class="modal-title" id="standard-modalLabel">{{ task.taskname }}</h4>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-hidden="true"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <ul class="list-group list-group-flush todo-list" id="todo-list{{ task.id }}">
                                                    </ul>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                                                        닫기
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {% elif '개발완료' in task.progress_status %}
                                    <p class="mb-2 fw-bold">개발 완료</p>
                                    {% else %}
                                    <p>
                                    <i class="ri-information-line"
   tabindex="0" data-bs-toggle="popover"
   data-bs-trigger="focus"
   data-bs-content="{{ task.change_reason|linebreaks }}"
   title="{{ task.progress_status }}"
   type="button"
   style="font-size: 16px;"
   data-bs-html="true"></i>

                                    </p>
                                    {% endif %}
                                </li>
                            </ul>
                        </div> <!-- end card-->
                    </div> <!-- end col -->
                    {% endfor %}

                </div>
                <!-- end row-->

            </div> <!-- container -->

        </div> <!-- content -->
        {% include 'page/footer_bottom.html' %}

    </div>



</div>
<!-- END wrapper -->

<script>
function ongoing(button) {
        var buttons = document.querySelectorAll('.btns .btn');
        buttons.forEach(function(btn) {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-light');
        });

        button.classList.remove('btn-light');
        button.classList.add('btn-primary');
    var classList = ['.접수', '.재개발', '.개발중', '.운영중단', '.개발중단', '.요청철회'];

    classList.forEach(function(className) {
        var cardElements = document.querySelectorAll(className);

        if (cardElements.length > 0) {
            cardElements.forEach(function(cardElement) {
                cardElement.style.display = 'none';
            });
        }
    });

    var classList = ['.개발완료', '.임시중단'];

    classList.forEach(function(className) {
        var cardElements = document.querySelectorAll(className);

        if (cardElements.length > 0) {
            cardElements.forEach(function(cardElement) {
                cardElement.style.display = 'inline';
            });
        }
    });

}


function ongoing_dev(button) {
        var buttons = document.querySelectorAll('.btns .btn');
        buttons.forEach(function(btn) {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-light');
        });

        button.classList.remove('btn-light');
        button.classList.add('btn-primary');
    var classList = ['.개발완료', '.운영중단', '.개발중단', '.임시중단', '.요청철회'];

    classList.forEach(function(className) {
        var cardElements = document.querySelectorAll(className);

        if (cardElements.length > 0) {
            cardElements.forEach(function(cardElement) {
                cardElement.style.display = 'none';
            });
        }
    });

    var classList = ['.개발중', '.재개발', '.접수', '.개발보류'];

    classList.forEach(function(className) {
        var cardElements = document.querySelectorAll(className);

        if (cardElements.length > 0) {
            cardElements.forEach(function(cardElement) {
                cardElement.style.display = 'inline';
            });
        }
    });
}


function alltask(button) {
        var buttons = document.querySelectorAll('.btns .btn');
        buttons.forEach(function(btn) {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-light');
        });

        button.classList.remove('btn-light');
        button.classList.add('btn-primary');
    var classList = ['.접수', '.재개발', '.개발중', '.개발완료', '.개발보류', '.운영중단', '.개발중단', '.임시중단', '.요청철회'];

    classList.forEach(function(className) {
        var cardElements = document.querySelectorAll(className);

        if (cardElements.length > 0) {
            cardElements.forEach(function(cardElement) {
                cardElement.style.display = 'inline';
            });
        }
    });
}

function stoptask(button) {
        var buttons = document.querySelectorAll('.btns .btn');
        buttons.forEach(function(btn) {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-light');
        });

        button.classList.remove('btn-light');
        button.classList.add('btn-primary');
    var classList = ['.접수', '.개발중', '.재개발', '.개발완료'];

    classList.forEach(function(className) {
        var cardElements = document.querySelectorAll(className);

        if (cardElements.length > 0) {
            cardElements.forEach(function(cardElement) {
                cardElement.style.display = 'none';
            });
        }
    });

    var classList = ['.운영중단', '.개발중단', '.임시중단', '.요청철회'];

    classList.forEach(function(className) {
        var cardElements = document.querySelectorAll(className);

        if (cardElements.length > 0) {
            cardElements.forEach(function(cardElement) {
                cardElement.style.display = 'inline';
            });
        }
    });
}
var detailInfo = {{ detailinfojson|safe }};

for (var i = 0; i < detailInfo.length; i++) {
  var counter = 0;
  var jsonString = detailInfo[i].fields.progress_job;
  var chk_task_cone = detailInfo[i].fields.task_completed;

  if (chk_task_cone === "Y") {
    continue;
  }

  var jsonString_done = detailInfo[i].fields.progress_job_done;
  var rpa_id = detailInfo[i].fields.rpa_id;
  var floatEndElement = document.getElementById("float-end" + rpa_id);
  if (!floatEndElement) {
      continue;
  }
  var arr = JSON.parse(jsonString);
  var arrDone = JSON.parse(jsonString_done);
  var totalItemCount = arrDone.length;
  var yCount = 0;

  arr.forEach(function(item) {
    var isChecked = false;
    var chkboolean = arrDone[counter];
    if (chkboolean == 'Y') {
      isChecked = true;
    }

    var newHtml = `
        <li class="list-group-item border-0 ps-0">
            <div class="form-check mb-0">
                <input type="checkbox" class="form-check-input ${isChecked ? 'todo-done' : ''}" id="1" ${isChecked ? 'checked' : ''} disabled>
                <label class="form-check-label" for="1">
                    ${isChecked ? '<s>' + item + '</s>' : item}
                </label>
            </div>
        </li>
    `;
    counter++;

    var handleDragulaLeft = document.getElementById("todo-list" + rpa_id);


    var tempDiv = document.createElement("div");
    tempDiv.innerHTML = newHtml;

    while (tempDiv.firstChild) {
      handleDragulaLeft.appendChild(tempDiv.firstChild);
    }

    if (chkboolean === "Y") {
      yCount++;
    }
  });

  var percentageY = Math.floor((yCount / totalItemCount) * 100);
  var progressBar = document.getElementById("progressbar" + rpa_id);
  var spanElement = document.getElementById("float-end" + rpa_id);

  if (spanElement) {
    spanElement.textContent = percentageY + "%";
  }

  if (progressBar) {
    progressBar.setAttribute("aria-valuenow", percentageY);
    progressBar.style.width = percentageY + "%";
  }
}


function cancelrequest(taskid) {
    var reason = document.querySelector("#explanation-textarea" + taskid).value;
    var rpa_id = taskid;
    let tableData = [];
    let rowData = {};
    rowData.rpaid = rpa_id;
    rowData.reason = reason;
    tableData.push(rowData);

  fetch('/cancelrequest/', {
    method: 'POST',
    body: JSON.stringify(tableData),
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value,
    },
  })
    .then(() => {
      setTimeout(() => {
      $('#danger-header-modal' + taskid).modal('toggle');
        window.location.reload();
      }, 0);
    })
    .catch((error) => {
      console.error('Error:', error);
    });
}

</script>
<!-- Vendor js -->
<script src="{% static 'assets/js/vendor.min.js' %}"></script>

<!-- App js -->
<script src="{% static 'assets/js/app.min.js' %}"></script>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script>
  $(function () {
    $('.modal-dialog').draggable({
      handle: ".modal-header"
    });
  });
</script>
</body>
</html>
